(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/avatar/avatar"],{"2b56":function(t,e,a){"use strict";var n=a("e008"),i=a.n(n);i.a},4765:function(t,e,a){"use strict";(function(t,n){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var i=r(a("a34a")),s=a("6457");function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e,a,n,i,s,r){try{var o=t[s](r),c=o.value}catch(h){return void a(h)}o.done?e(c):Promise.resolve(c).then(n,i)}function c(t){return function(){var e=this,a=arguments;return new Promise((function(n,i){var s=t.apply(e,a);function r(t){o(s,n,i,r,c,"next",t)}function c(t){o(s,n,i,r,c,"throw",t)}r(void 0)}))}}var h={1:"china",2:"chris",3:"holiday",4:"new",5:"love"},l={data:function(){return{AvatarUrl:s.AvatarUrl,PageUrl:s.PageUrl,duration:15,windowHeight:0,cansWidth:270,cansHeight:270,imgList:(0,s.range)(0,6,1),currentMaskId:-1,showBorder:!1,maskCenterX:wx.getSystemInfoSync().windowWidth/2,maskCenterY:250,cancelCenterX:wx.getSystemInfoSync().windowWidth/2-50-2,cancelCenterY:200,handleCenterX:wx.getSystemInfoSync().windowWidth/2+50-2,handleCenterY:300,maskSize:100,scale:1,rotate:0,rotateY:0,mask_center_x:wx.getSystemInfoSync().windowWidth/2,mask_center_y:250,cancel_center_x:wx.getSystemInfoSync().windowWidth/2-50-2,cancel_center_y:200,handle_center_x:wx.getSystemInfoSync().windowWidth/2+50-2,handle_center_y:300,scaleCurrent:1,rotateCurrent:0,touch_target:"",start_x:0,start_y:0,avatarType:1,avatarPath:"",imageInfo:"献礼71周年华诞，为祖国母亲庆生"}},computed:{maskPic:function(){var t=this.avatarType,e=this.currentMaskId,a=h[t];return"/static/image/".concat(a,"/").concat(e,".png")},pageImage:function(){var t=this.avatarType,e=void 0===t?1:t,a=this.PageUrl;return console.log("背景",a[e]),a[e]},imgPath:function(){var t=this.avatarType;return h[t]},avatarPathImage:{get:function(){var t=this.avatarType,e=void 0===t?1:t,a=this.AvatarUrl;return console.log("背景",a[e]),this.avatarPath=a[e],a[e]},set:function(t){this.avatarPath=t}},imgInfoColor:function(){var t=this.avatarType,e=5===t?["text-white"]:"";return e},btnColor:function(){var t=this.avatarType,e=5===t?["bg-white"]:"";return e}},onLoad:function(t){wx.showShareMenu({menus:["shareAppMessage","shareTimeline"],success:function(t){console.log(t)},fail:function(t){console.log(t)}}),this.handleOption(t),console.log(t)},onShareAppMessage:function(){var t=this.imageInfo,e=this.avatarPathImage;return{title:t,imageUrl:e,path:"/pages/avatar/avatar",success:function(t){console.log(t)}}},methods:{handelGetPageUrl:function(e){return c(i.default.mark((function a(){var s;return i.default.wrap((function(a){while(1)switch(a.prev=a.next){case 0:return a.next=2,t.callFunction({name:"page-url-query",data:{type:e}}).catch((function(t){n.hideLoading(),n.showModal({content:"查询失败，错误信息为：".concat(t.message),showCancel:!1}),console.error(t)}));case 2:s=a.sent,s.result.data,n.hideLoading();case 5:case"end":return a.stop()}}),a)})))()},handleOption:function(t){var e=(null===t||void 0===t?void 0:t.item)?JSON.parse(null===t||void 0===t?void 0:t.item):{},a=e.avatarType,n=void 0===a?1:a,i=e.info;this.avatarType=n,this.imageInfo=i,this.handelGetPageUrl(n),this.windowHeight=getApp().globalData.windowHeight},touchAvatarBg:function(){this.showBorder=!1},touchStart:function(t){console.log("e.target.id",t.target.id),"mask"==t.target.id?(this.touch_target="mask",this.showBorder=!0):"handle"==t.target.id?this.touch_target="handle":this.touch_target="",""!=this.touch_target&&(this.start_x=t.touches[0].clientX,this.start_y=t.touches[0].clientY)},touchMove:function(t){var e=t.touches[0].clientX,a=t.touches[0].clientY,n=e-this.start_x,i=a-this.start_y;if("mask"==this.touch_target&&(this.maskCenterX=this.maskCenterX+n,this.maskCenterY=this.maskCenterY+i,this.cancelCenterX=this.cancelCenterX+n,this.cancelCenterY=this.cancelCenterY+i,this.handleCenterX=this.handleCenterX+n,this.handleCenterY=this.handleCenterY+i),"handle"==this.touch_target){this.handleCenterX=this.handleCenterX+n,this.handleCenterY=this.handleCenterY+i,this.cancelCenterX=2*this.maskCenterX-this.handleCenterX,this.cancelCenterY=2*this.maskCenterY-this.handleCenterY;var s=this.handle_center_x-this.mask_center_x,r=this.handle_center_y-this.mask_center_y,o=this.handleCenterX-this.mask_center_x,c=this.handleCenterY-this.mask_center_y,h=Math.sqrt(s*s+r*r),l=Math.sqrt(o*o+c*c),u=Math.atan2(r,s)/Math.PI*180,d=Math.atan2(c,o)/Math.PI*180;this.scale=l/h*this.scaleCurrent,this.rotate=d-u+this.rotateCurrent}this.start_x=e,this.start_y=a},touchEnd:function(t){this.mask_center_x=this.maskCenterX,this.mask_center_y=this.maskCenterY,this.cancel_center_x=this.cancelCenterX,this.cancel_center_y=this.cancelCenterY,this.handle_center_x=this.handleCenterX,this.handle_center_y=this.handleCenterY,this.touch_target="",this.scaleCurrent=this.scale,this.rotateCurrent=this.rotate},getUserInfo:function(t){var e=this;if("getUserInfo:ok"===t.detail.errMsg){var a=t.detail.userInfo;a.avatarUrl=a.avatarUrl.replace("132","0"),console.log("头像",a.avatarUrl),n.downloadFile({url:a.avatarUrl,success:function(t){n.hideLoading(),e.avatarPath=t.tempFilePath},fail:function(t){console.log(t),e.handleImageModal()}})}else n.showModal({title:"获取用户头像失败",content:"用户信息仅用于创建新的图片，请放心使用",showCancel:!1})},handleImageModal:function(){var t=this;n.hideLoading(),n.showModal({title:"图片加载超时",content:"网络异常，请稍后重试",success:function(e){e.confirm?t.downloadAvatarAndPaintAll():e.cancel&&console.log("用户点击取消")}})},changeMask:function(t){this.currentMaskId=t.target.dataset.maskId,this.showBorder=!0},draw:function(){-1!=this.currentMaskId?this.handleDrawImage():n.showToast({title:"您还没选择挂件哦",duration:2e3,icon:"none"})},handleDrawImage:function(){var t=this,e=this.maskPic,a=this.avatarPath,n=this.scale,i=this.rotate,s=this.isAndroid,r=this.cansWidth,o=this.cansHeight,c=this.mask_center_x,h=this.mask_center_y,l=wx.createSelectorQuery();l.select("#avatar-bg").boundingClientRect(),l.exec((function(l){c-=l[0].left,h-=l[0].top;var u=wx.createCanvasContext("cans-id-mask"),d=(wx.getSystemInfoSync().windowWidth,100*n);u.clearRect(0,0,r,o),u.drawImage(a,0,0,r,o),u.translate(c,h),u.rotate(i*Math.PI/180),s&&180==t.rotateY&&u.scale(-1,1),u.drawImage(e,-d/2,-d/2,d,d),u.draw(),t.saveCans()}))},handleSaveSuccess:function(t){var e=this,a=t.tempFilePath;n.hideLoading(),n.saveImageToPhotosAlbum({filePath:a,success:function(t){n.showModal({title:"保存成功",content:"头像已经在您的相册里啦",showCancel:!1}),n.vibrateShort({success:function(){console.log("vibrateShort")}})},fail:function(t){t.errMsg.indexOf("fail")&&e.hadleSaveErrorModal()}})},hadleSaveErrorModal:function(){n.showModal({title:"您需要授权相册权限",success:function(t){t.confirm&&n.openSetting({success:function(t){console.log("相册授权成功")},fail:function(t){console.log(t)}})}})},handleSaveImage:function(){var t=this;n.canvasToTempFilePath({x:0,y:0,height:this.cansWidth,width:this.cansHeight,destWidth:3*this.cansWidth,destHeight:3*this.cansHeight,canvasId:"cans-id-mask",success:function(e){t.handleSaveSuccess(e)},fail:function(t){n.hideLoading()}},this)},saveCans:function(){n.showLoading({title:"保存...",mask:!0}),this.handleSaveImage()}}};e.default=l}).call(this,a("a9ff")["default"],a("543d")["default"])},"5b2e":function(t,e,a){"use strict";var n;a.d(e,"b",(function(){return i})),a.d(e,"c",(function(){return s})),a.d(e,"a",(function(){return n}));var i=function(){var t=this,e=t.$createElement;t._self._c},s=[]},"5dfc":function(t,e,a){"use strict";a.r(e);var n=a("5b2e"),i=a("bba2");for(var s in i)"default"!==s&&function(t){a.d(e,t,(function(){return i[t]}))}(s);a("2b56");var r,o=a("f0c5"),c=Object(o["a"])(i["default"],n["b"],n["c"],!1,null,"1e240766",null,!1,n["a"],r);e["default"]=c.exports},bba2:function(t,e,a){"use strict";a.r(e);var n=a("4765"),i=a.n(n);for(var s in n)"default"!==s&&function(t){a.d(e,t,(function(){return n[t]}))}(s);e["default"]=i.a},e008:function(t,e,a){},ff89:function(t,e,a){"use strict";(function(t){a("fbbb");n(a("66fd"));var e=n(a("5dfc"));function n(t){return t&&t.__esModule?t:{default:t}}t(e.default)}).call(this,a("543d")["createPage"])}},[["ff89","common/runtime","common/vendor"]]]);