(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/avatar/avatar"],{"2c32":function(t,e,n){},4765:function(t,e,n){"use strict";(function(t,a){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var r=o(n("a34a")),i=n("6457");function o(t){return t&&t.__esModule?t:{default:t}}function s(t,e){return d(t)||u(t,e)||l(t,e)||c()}function c(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function l(t,e){if(t){if("string"===typeof t)return h(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?h(t,e):void 0}}function h(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,a=new Array(e);n<e;n++)a[n]=t[n];return a}function u(t,e){if("undefined"!==typeof Symbol&&Symbol.iterator in Object(t)){var n=[],a=!0,r=!1,i=void 0;try{for(var o,s=t[Symbol.iterator]();!(a=(o=s.next()).done);a=!0)if(n.push(o.value),e&&n.length===e)break}catch(c){r=!0,i=c}finally{try{a||null==s["return"]||s["return"]()}finally{if(r)throw i}}return n}}function d(t){if(Array.isArray(t))return t}function f(t,e,n,a,r,i,o){try{var s=t[i](o),c=s.value}catch(l){return void n(l)}s.done?e(c):Promise.resolve(c).then(a,r)}function g(t){return function(){var e=this,n=arguments;return new Promise((function(a,r){var i=t.apply(e,n);function o(t){f(i,a,r,o,s,"next",t)}function s(t){f(i,a,r,o,s,"throw",t)}o(void 0)}))}}var v={1:"china",2:"chris",3:"holiday",4:"new",5:"love"},m=function(){n.e("components/uni-fab/uni-fab").then(function(){return resolve(n("27a0"))}.bind(null,n)).catch(n.oe)},w={components:{uniFab:m},data:function(){return{fabList:i.fabList,AvatarUrl:i.AvatarUrl,PageUrl:i.PageUrl,duration:15,windowHeight:0,cansWidth:270,cansHeight:270,currentMaskId:-1,showBorder:!1,maskCenterX:wx.getSystemInfoSync().windowWidth/2,maskCenterY:250,cancelCenterX:wx.getSystemInfoSync().windowWidth/2-50-2,cancelCenterY:200,handleCenterX:wx.getSystemInfoSync().windowWidth/2+50-2,handleCenterY:300,maskSize:100,scale:1,rotate:0,rotateY:0,mask_center_x:wx.getSystemInfoSync().windowWidth/2,mask_center_y:250,cancel_center_x:wx.getSystemInfoSync().windowWidth/2-50-2,cancel_center_y:200,handle_center_x:wx.getSystemInfoSync().windowWidth/2+50-2,handle_center_y:300,scaleCurrent:1,rotateCurrent:0,touch_target:"",start_x:0,start_y:0,avatarType:1,avatarPath:"",imageInfo:"把袜子翻过来，里朝外，挂起来，整个世界都是你的礼物",imgList:[],pageUrl:"",avatarUrl:"",maskPic:"",isAndroid:getApp().globalData.IS_ANDROID}},computed:{pageImage:function(){var t=this.pageUrl;return t},imgPath:function(){var t=this.avatarType;return v[t]},imgInfoColor:function(){var t=this.avatarType,e=5===t?["text-white"]:"";return e},btnColor:function(){var t=this.avatarType,e=5===t?["bg-white"]:"";return e}},onLoad:function(t){wx.showShareMenu({menus:["shareAppMessage","shareTimeline"],success:function(t){console.log(t)},fail:function(t){console.log(t)}}),this.handleOption(t),console.log(t)},onShareAppMessage:function(){var t=this.imageInfo,e=this.avatarUrl;return{title:t,imageUrl:e,path:"/pages/avatar/avatar",success:function(t){console.log(t)}}},methods:{handleTrigger:function(e){var n=e.index;switch(n){case 0:t.navigateBack({delta:1});break;case 1:t.switchTab({url:"/pages/images/images"});break;default:t.navigateBack({delta:1});break}console.log(e)},handelGetPageUrl:function(e){var n=this;return g(r.default.mark((function i(){var o,c,l,h,u;return r.default.wrap((function(r){while(1)switch(r.prev=r.next){case 0:return t.showLoading({title:"加载中..."}),r.next=3,a.callFunction({name:"page-url-query",data:{type:e}}).catch((function(e){t.hideLoading(),t.showModal({content:"查询失败，错误信息为：".concat(e.message),showCancel:!1}),console.error(e)}));case 3:o=r.sent,c=o.result.data,l=s(c,1),h=l[0],u=h.photo_url,h.photo_url=u.split("*"),n.imgList=h.photo_url,n.avatarUrl=h.avatar_url,n.pageUrl=h.page_url,console.log("查询的数据",h),t.hideLoading();case 13:case"end":return r.stop()}}),i)})))()},handleOption:function(t){var e=(null===t||void 0===t?void 0:t.item)?JSON.parse(null===t||void 0===t?void 0:t.item):{},n=e.avatarType,a=void 0===n?1:n,r=e.info;this.avatarType=a,this.imageInfo=r,this.handelGetPageUrl(a),this.windowHeight=getApp().globalData.windowHeight},touchAvatarBg:function(){this.showBorder=!1},touchStart:function(t){console.log("e.target.id",t.target.id),"mask"==t.target.id?(this.touch_target="mask",this.showBorder=!0):"handle"==t.target.id?this.touch_target="handle":this.touch_target="",""!=this.touch_target&&(this.start_x=t.touches[0].clientX,this.start_y=t.touches[0].clientY)},touchMove:function(t){var e=t.touches[0].clientX,n=t.touches[0].clientY,a=e-this.start_x,r=n-this.start_y;if("mask"==this.touch_target&&(this.maskCenterX=this.maskCenterX+a,this.maskCenterY=this.maskCenterY+r,this.cancelCenterX=this.cancelCenterX+a,this.cancelCenterY=this.cancelCenterY+r,this.handleCenterX=this.handleCenterX+a,this.handleCenterY=this.handleCenterY+r),"handle"==this.touch_target){this.handleCenterX=this.handleCenterX+a,this.handleCenterY=this.handleCenterY+r,this.cancelCenterX=2*this.maskCenterX-this.handleCenterX,this.cancelCenterY=2*this.maskCenterY-this.handleCenterY;var i=this.handle_center_x-this.mask_center_x,o=this.handle_center_y-this.mask_center_y,s=this.handleCenterX-this.mask_center_x,c=this.handleCenterY-this.mask_center_y,l=Math.sqrt(i*i+o*o),h=Math.sqrt(s*s+c*c),u=Math.atan2(o,i)/Math.PI*180,d=Math.atan2(c,s)/Math.PI*180;this.scale=h/l*this.scaleCurrent,this.rotate=d-u+this.rotateCurrent}this.start_x=e,this.start_y=n},touchEnd:function(t){this.mask_center_x=this.maskCenterX,this.mask_center_y=this.maskCenterY,this.cancel_center_x=this.cancelCenterX,this.cancel_center_y=this.cancelCenterY,this.handle_center_x=this.handleCenterX,this.handle_center_y=this.handleCenterY,this.touch_target="",this.scaleCurrent=this.scale,this.rotateCurrent=this.rotate},getUserInfo:function(e){var n=this;if("getUserInfo:ok"===e.detail.errMsg){var a=e.detail.userInfo;a.avatarUrl=a.avatarUrl.replace("132","0"),console.log("头像",a.avatarUrl),t.showLoading({title:"加载中..."}),t.downloadFile({url:a.avatarUrl,success:function(e){t.hideLoading(),n.avatarUrl=e.tempFilePath},fail:function(t){console.log(t),n.handleImageModal()}})}else t.showModal({title:"获取用户头像失败",content:"用户信息仅用于创建新的图片，请放心使用",showCancel:!1})},handleImageModal:function(){var e=this;t.hideLoading(),t.showModal({title:"图片加载超时",content:"网络异常，请稍后重试",success:function(t){t.confirm?e.downloadAvatarAndPaintAll():t.cancel&&console.log("用户点击取消")}})},changeMask:function(t){var e=this;return g(r.default.mark((function n(){var a,i;return r.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:a=t.target.dataset.maskId,e.currentMaskId=a,i=e.imgList[a],e.maskPic=i,e.showBorder=!0;case 5:case"end":return n.stop()}}),n)})))()},draw:function(){-1!=this.currentMaskId?this.handleDrawImage():t.showToast({title:"您还没选择挂件哦",duration:2e3,icon:"none"})},getImageInfo:function(e){return t.showLoading({title:"加载中"}),new Promise((function(n,a){t.getImageInfo({src:e,success:function(e){console.log("获取的图片信息",e.path),t.hideLoading(),n(e.path)}})}))},handleDrawImage:function(){var t=this;return g(r.default.mark((function e(){var n,a,i,o,s,c,l,h;return r.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:n=t.scale,a=t.rotate,i=t.isAndroid,o=t.cansWidth,s=t.cansHeight,t.currentMaskId,c=t.mask_center_x,l=t.mask_center_y,h=wx.createSelectorQuery(),h.select("#avatar-bg").boundingClientRect(),h.exec(function(){var e=g(r.default.mark((function e(h){var u,d,f,g;return r.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return c-=h[0].left,l-=h[0].top,u=wx.createCanvasContext("cans-id-mask"),wx.getSystemInfoSync().windowWidth,d=100*n,e.next=7,t.getImageInfo(t.maskPic);case 7:return f=e.sent,e.next=10,t.getImageInfo(t.avatarUrl);case 10:return g=e.sent,u.clearRect(0,0,o,s),u.drawImage(g,0,0,o,s),u.translate(c,l),u.rotate(a*Math.PI/180),i&&180==t.rotateY&&u.scale(-1,1),u.drawImage(f,-d/2,-d/2,d,d),e.next=19,u.draw(!1,(function(){t.saveCans()}));case 19:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 5:case"end":return e.stop()}}),e)})))()},handleSaveSuccess:function(e){var n=this,a=e.tempFilePath;t.hideLoading(),t.saveImageToPhotosAlbum({filePath:a,success:function(e){t.showModal({title:"保存成功",content:"头像已经在您的相册里啦",showCancel:!1}),t.vibrateShort({success:function(){console.log("vibrateShort")}})},fail:function(t){t.errMsg.indexOf("fail")&&n.hadleSaveErrorModal()}})},hadleSaveErrorModal:function(){t.showModal({title:"您需要授权相册权限",success:function(e){e.confirm&&t.openSetting({success:function(t){console.log("相册授权成功")},fail:function(t){console.log(t)}})}})},handleSaveImage:function(){var e=this;t.canvasToTempFilePath({x:0,y:0,height:this.cansWidth,width:this.cansHeight,destWidth:3*this.cansWidth,destHeight:3*this.cansHeight,canvasId:"cans-id-mask",success:function(t){console.log("canvas",t.tempFilePath),e.handleSaveSuccess(t)},fail:function(e){t.hideLoading()}},this)},saveCans:function(){t.showLoading({title:"保存...",mask:!0}),this.handleSaveImage()}}};e.default=w}).call(this,n("543d")["default"],n("a9ff")["default"])},"5dfc":function(t,e,n){"use strict";n.r(e);var a=n("edeb"),r=n("bba2");for(var i in r)"default"!==i&&function(t){n.d(e,t,(function(){return r[t]}))}(i);n("fa67");var o,s=n("f0c5"),c=Object(s["a"])(r["default"],a["b"],a["c"],!1,null,"1d748344",null,!1,a["a"],o);e["default"]=c.exports},bba2:function(t,e,n){"use strict";n.r(e);var a=n("4765"),r=n.n(a);for(var i in a)"default"!==i&&function(t){n.d(e,t,(function(){return a[t]}))}(i);e["default"]=r.a},edeb:function(t,e,n){"use strict";n.d(e,"b",(function(){return r})),n.d(e,"c",(function(){return i})),n.d(e,"a",(function(){return a}));var a={uniFab:function(){return n.e("components/uni-fab/uni-fab").then(n.bind(null,"27a0"))}},r=function(){var t=this,e=t.$createElement;t._self._c},i=[]},fa67:function(t,e,n){"use strict";var a=n("2c32"),r=n.n(a);r.a},ff89:function(t,e,n){"use strict";(function(t){n("fbbb");a(n("66fd"));var e=a(n("5dfc"));function a(t){return t&&t.__esModule?t:{default:t}}t(e.default)}).call(this,n("543d")["createPage"])}},[["ff89","common/runtime","common/vendor"]]]);